/* This file is part of the bladeRF project:
 *   http://www.github.com/nuand/bladeRF
 *
 * Copyright (c) 2015 Nuand LLC
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
#ifdef BLADERF_NIOS_PC_SIMULATION

#include <stdlib.h>
#include <stdint.h>
#include <stdbool.h>
#include <inttypes.h>

#include "pkt_handler.h"
#include "devices.h"
#include "fpga_version.h"

#include "debug.h"

/* This global is used to flag the end of a simulation */
bool run_nios = true;

static size_t msg_idx = 0;
static size_t test_case_idx = 0;

static size_t write_idx = 0;
static uint8_t write_buf[NIOS_PKT_LEN] = { 0 };

struct test_case {
    const char *desc;
    const uint8_t req[NIOS_PKT_LEN];
    const uint8_t resp[NIOS_PKT_LEN];
};

static const struct test_case test_cases[] = {
    {
        .desc = "Garbage input. Should yield no output.",
        .req = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
    },

    {
        .desc = "Legacy read from LM6[0x2f]",
        .req =  { 0x4e, 0x91, 0x2f, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x91, 0x2f, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy write to LM6[0x07] <- 0x09",
        .req =  { 0x4e, 0x51, 0x07, 0x09, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x51, 0x07, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy read from Si5338[0x03]",
        .req  = { 0x4e, 0xb1, 0x03, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0xb1, 0x03, 0x88, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy write to Si5338[0x05] <- 0xab",
        .req  = { 0x4e, 0x71, 0x05, 0xab, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x71, 0x05, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy config register read, access 1/4",
        .req  = { 0x4e, 0x81, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x00, 0x57, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy config register read, access 2/4",
        .req  = { 0x4e, 0x81, 0x01, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x01, 0xde, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy config register read, access 3/4",
        .req  = { 0x4e, 0x81, 0x02, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x02, 0xbc, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
       .desc = "Legacy config register read, access 4/4",
       .req  = { 0x4e, 0x81, 0x03, 0xff, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
       .resp = { 0x4e, 0x81, 0x03, 0x8a, 0xff, 0xff, 0xff, 0xff,
                 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
       .desc = "Legacy config register write, access 1/4",
       .req  = { 0x4e, 0x41, 0x00, 0x57, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
       .resp = { 0x4e, 0x41, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
                 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
       .desc = "Legacy config register write, access 2/4",
       .req  = { 0x4e, 0x41, 0x01, 0x20, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
       .resp = { 0x4e, 0x41, 0x01, 0x00, 0xff, 0xff, 0xff, 0xff,
                 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
       .desc = "Legacy config register write, access 3/4",
       .req  = { 0x4e, 0x41, 0x02, 0x40, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
       .resp = { 0x4e, 0x41, 0x02, 0x00, 0xff, 0xff, 0xff, 0xff,
                 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
       .desc = "Legacy config register write, access 4/4",
       .req  = { 0x4e, 0x41, 0x03, 0x80, 0x00, 0x00, 0x00, 0x00,
                 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
       .resp = { 0x4e, 0x41, 0x03, 0x00, 0xff, 0xff, 0xff, 0xff,
                 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy read of RX IQ gain correction 1/2",
        .req  = { 0x4e, 0x81, 0x04, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x00, 0xd2, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },

    },

    {
        .desc = "Legacy read of RX IQ gain correction 2/2",
        .req  = { 0x4e, 0x81, 0x05, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x01, 0x14, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy write of RX IQ gain correction 1/2",
        .req  = { 0x4e, 0x41, 0x04, 0xd2, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy write of RX IQ gain correction 2/2",
        .req  = { 0x4e, 0x41, 0x05, 0x14, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x01, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy read of RX IQ phase correction 1/2",
        .req  = { 0x4e, 0x81, 0x06, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x00, 0x1c, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy read of RX IQ phase correction 2/2",
        .req  = { 0x4e, 0x81, 0x07, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x01, 0x10, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
   },

    {
        .desc = "Legacy write of RX IQ phase correction 1/2",
        .req  = { 0x4e, 0x41, 0x06, 0x1c, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy write of RX IQ phase correction 2/2",
        .req  = { 0x4e, 0x41, 0x07, 0x10, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x01, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy read of TX IQ gain correction 1/2",
        .req  = { 0x4e, 0x81, 0x08, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x00, 0x12, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },

    },

    {
        .desc = "Legacy read of TX IQ gain correction 2/2",
        .req  = { 0x4e, 0x81, 0x09, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x01, 0x08, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy write of TX IQ gain correction 1/2",
        .req  = { 0x4e, 0x41, 0x08, 0x12, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy write of TX IQ gain correction 2/2",
        .req  = { 0x4e, 0x41, 0x09, 0x08, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x01, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy read of TX IQ phase correction 1/2",
        .req  = { 0x4e, 0x81, 0x0a, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy read of TX IQ phase correction 2/2",
        .req  = { 0x4e, 0x81, 0x0b, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x01, 0x02, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
   },

    {
        .desc = "Legacy write of TX IQ phase correction 1/2",
        .req  = { 0x4e, 0x41, 0x0a, 0x1f, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy write of TX IQ phase correction 2/2",
        .req  = { 0x4e, 0x41, 0x0b, 0x02, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x01, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy read of FPGA version 1/4",
        .req  = { 0x4e, 0x81, 0x0c, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x00, FPGA_VERSION_MAJOR & 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy read of FPGA version 2/4",
        .req  = { 0x4e, 0x81, 0x0d, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x01, FPGA_VERSION_MINOR & 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy read of FPGA version 3/4",
        .req  = { 0x4e, 0x81, 0x0e, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x02, FPGA_VERSION_PATCH & 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy read of FPGA version 4/4",
        .req  = { 0x4e, 0x81, 0x0f, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x03, (FPGA_VERSION_PATCH >> 8) & 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
                  0xff },
    },

    /* TODO: Invalid Legacy FPGA version # write attempt */

    /* TODO: Legacy RX and TX timestamps reads */

    {
        .desc = "VCTCXO trim dac write 1/2",
        .req  = { 0x4e, 0x41, 0x22, 0x12, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "VCTCXO trim dac write 2/2",
        .req  = { 0x4e, 0x41, 0x23, 0x80, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x01, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    /* TODO: VCTCXO readback */

    {
        .desc = "Legacy XB-200 synth write 1/4",
        .req  = { 0x4e, 0x41, 0x24, 0x05, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy XB-200 synth write 2/4",
        .req  = { 0x4e, 0x41, 0x25, 0x00, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x01, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy XB-200 synth write 3/4",
        .req  = { 0x4e, 0x41, 0x26, 0x58, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x02, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy XB-200 synth write 4/4",
        .req  = { 0x4e, 0x41, 0x27, 0x00, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x03, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {   .desc = "Legacy expansion port read 1/4",
        .req  = { 0x4e, 0x81, 0x28, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy expansion port read 2/4",
        .req  = { 0x4e, 0x81, 0x29, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x01, 0xc7, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy expansion port read 3/4",
        .req  = { 0x4e, 0x81, 0x2a, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x02, 0xff, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy expansion port read 4/4",
        .req  = { 0x4e, 0x81, 0x2b, 0xff, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x81, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy expansion port write 1/4",
        .req  = { 0x4e, 0x41, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy expansion port write 2/4",
        .req  = { 0x4e, 0x41, 0x29, 0x08, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x01, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy expansion port write 3/4",
        .req  = { 0x4e, 0x41, 0x2a, 0x00, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x02, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy expansion port write 4/4",
        .req  = { 0x4e, 0x41, 0x2b, 0x3c, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x03, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    /* TODO: Legacy expansion port direction read */
    {
        .desc = "Legacy expansion port direction read 1/4",
        .req  = { 0x4e, 0x41, 0x2c, 0x3e, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy expansion port direction read 2/4",
        .req  = { 0x4e, 0x41, 0x2d, 0x38, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x01, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy expansion port direction read 3/4",
        .req  = { 0x4e, 0x41, 0x2e, 0x00, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x02, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    },

    {
        .desc = "Legacy expansion port direction read 4/4",
        .req  = { 0x4e, 0x41, 0x2f, 0x3c, 0x00, 0x00, 0x00, 0x00,
                  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
        .resp = { 0x4e, 0x41, 0x03, 0x00, 0xff, 0xff, 0xff, 0xff,
                  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff },
    }


  };

const char *module2str(bladerf_module m)
{
    switch (m) {
        case BLADERF_MODULE_RX:
            return "RX";

        case BLADERF_MODULE_TX:
            return "TX";

        default:
            return "Invalid";
    }
}

void bladerf_nios_init(void)
{
    DBG("%s()\n", __FUNCTION__);
}

uint8_t lms6_read(uint8_t addr) {
    const uint8_t ret = 0x00;
    DBG("%s: addr=0x%02x, returning 0x%02x\n", __FUNCTION__, addr, ret);
    ASSERT(0x2f);
    return ret;
}

void lms6_write(uint8_t addr, uint8_t data)
{
    DBG("%s: addr=0x%02x, data=0x%02x\n", __FUNCTION__, addr, data);
    ASSERT(addr == 0x07);
    ASSERT(data == 0x09);
}

uint8_t si5338_read(uint8_t addr)
{
    const uint8_t ret = 0x88;
    DBG("%s: addr=0x%02x, returning 0x%02x\n", __FUNCTION__, addr, ret);
    ASSERT(addr == 0x3);
    return ret;
}

void si5338_write(uint8_t addr, uint8_t data)
{
    DBG("%s: addr=0x%02x, data=0x%02x\n", __FUNCTION__, addr, data);
    ASSERT(addr == 0x05);
    ASSERT(data == 0xab);
}

void vctcxo_trim_dac_write(uint16_t val)
{
    DBG("%s: val=0x%04x\n", __FUNCTION__, val);
    ASSERT(val == 0x8012);
}

void adf4351_write(uint32_t val)
{
    DBG("%s: val=0x%08x\n", __FUNCTION__, val);
    ASSERT(0x580005);
}

bool fx3_uart_has_data(void)
{
    bool has_data = test_case_idx < ARRAY_SIZE(test_cases);
    DBG("%s = %s()\n", has_data ? "true" : "false", __FUNCTION__);
    return has_data;
}

uint8_t fx3_uart_read(void)
{
    uint8_t ret;

    if (msg_idx == 0) {
        printf("\nTest case %-2zd: %s\n", test_case_idx + 1,
                test_cases[test_case_idx].desc);
        printf("--------------------------------------------------------\n");
    }

    DBG("%s()\n", __FUNCTION__);

    if (test_case_idx >= ARRAY_SIZE(test_cases)) {
        return 0xff;
    }

    ret = test_cases[test_case_idx].req[msg_idx++];
    if (msg_idx >= NIOS_PKT_LEN) {
        msg_idx = 0;
        test_case_idx++;

        if (test_case_idx < ARRAY_SIZE(test_cases)) {
            DBG("Consumed test case data. Incrementing test case to idx=%zd "
                "for the next read(s).\n", test_case_idx);
        } else {
            DBG("Consumed data for final test case.\n");
            run_nios = false;
        }
    }

    return ret;
}

void fx3_uart_write(uint8_t data)
{
    DBG("%s: data=0x%02x\n", __FUNCTION__, data);
    if (write_idx > NIOS_PKT_LEN) {
        DBG("Overrun in simulated FX3 UART buffer detected!\n");
        ASSERT(0);
    } else {
        write_buf[write_idx++] = data;
    }
}

void SIMULATION_FLUSH_UART()
{
    print_bytes("Response data:", write_buf, sizeof(write_buf));

    /* At this point, we'll already have incremented the test_case_idx past
     * this test. */
    ASSERT(test_case_idx > 0);

    if (memcmp(write_buf, test_cases[test_case_idx - 1].resp, sizeof(write_buf))) {
        printf("Failed.\n");
        if (!getenv("CONTINUE_ON_FAIL")) {
                ASSERT(!"Aborting due to failed test case.\n");
        }
    } else {
        printf("Pass.\n\n");
    }

    memset(write_buf, 0, sizeof(write_buf));
    write_idx = 0;
}


uint32_t control_reg_read(void)
{
    uint32_t ret = 0x8abcde57;
    DBG("%s: returning 0x%08x\n", __FUNCTION__, ret);
    return ret;
}

void control_reg_write(uint32_t value)
{
    DBG("%s: value=0x%08x\n", __FUNCTION__, value);
    ASSERT(value == 0x80402057);
}

uint16_t iqbal_get_gain(bladerf_module m)
{
    uint16_t ret = 0xffff;

    switch (m) {
        case BLADERF_MODULE_RX:
            ret = 0x14d2;
            break;

        case BLADERF_MODULE_TX:
            ret = 0x0812;
            break;

        default:
            DBG("%s: Invalid module %u\n", __FUNCTION__, m);
            ASSERT(0);
    }

    DBG("%s: module=%s, returning 0x%04x\n",
        __FUNCTION__, module2str(m), ret);

    return ret;
}

void iqbal_set_gain(bladerf_module m, uint16_t value)
{
    switch (m) {
        case BLADERF_MODULE_RX:
            ASSERT(value == 0x14d2);
            break;

        case BLADERF_MODULE_TX:
            ASSERT(value == 0x0812);
            break;

        default:
            DBG("%s: Invalid module %u\n", __FUNCTION__, m);
            ASSERT(0);
    }

    DBG("%s: module=%s, value=0x%04x\n", __FUNCTION__, module2str(m), value);
}

uint16_t iqbal_get_phase(bladerf_module m)
{
    uint16_t ret = 0xffff;

    switch (m) {
        case BLADERF_MODULE_RX:
            ret = 0x101c;
            break;

        case BLADERF_MODULE_TX:
            ret = 0x021f;
            break;

        default:
            DBG("%s: Invalid module %u\n", __FUNCTION__, m);
            ASSERT(0);
    }

    DBG("%s: module=%s, returning 0x%04x\n",
        __FUNCTION__, module2str(m), ret);

    return ret;
}

void iqbal_set_phase(bladerf_module m, uint16_t value)
{
    switch (m) {
        case BLADERF_MODULE_RX:
            ASSERT(value == 0x101c);
            break;

        case BLADERF_MODULE_TX:
            ASSERT(value == 0x021f);
            break;

        default:
            DBG("%s: Invalid module %u\n", __FUNCTION__, m);
            ASSERT(0);
    }

    DBG("%s: module=%s, value=0x%04x\n", __FUNCTION__, module2str(m), value);
}

uint32_t expansion_port_read(void)
{
    uint32_t ret = 0xffffc7ff;
    DBG("%s: returning 0x%08x\n", __FUNCTION__, ret);
    return ret;
}

void expansion_port_write(uint32_t value)
{
    DBG("%s: value=0x%08x\n", __FUNCTION__, value);
    ASSERT(value == 0x3c000800);
}

uint32_t expansion_port_get_direction()
{
    uint32_t ret = 0x0a1b2c3d;
    DBG("%s: returning 0x%08x\n", __FUNCTION__, ret);
    return ret;
}

void expansion_port_set_direction(uint32_t dir)
{
    DBG("%s: dir=0x%08x\n", __FUNCTION__, dir);
}

uint64_t time_tamer_read(bladerf_module m)
{
    uint64_t ret = (uint64_t) -1;

    switch (m) {
        case BLADERF_MODULE_RX:
            ret = 0x0a1b2c3d;
            break;

        case BLADERF_MODULE_TX:
            ret = 0xa1b2c3d4;
            break;

        default:
            DBG("%s: Invalid module %u\n", __FUNCTION__, m);
            ASSERT(0);
            break;
    }

    DBG("%s: module=%s, returning 0x%016"PRIx64"\n",
         __FUNCTION__, module2str(m), ret);

    return ret;
}

void time_tamer_reset(bladerf_module m)
{
    switch (m) {
        case BLADERF_MODULE_RX:
        case BLADERF_MODULE_TX:
            break;

        default:
            DBG("%s: Invalid module %u\n", __FUNCTION__, m);
            ASSERT(0);
            break;
    }

    DBG("%s: module=%s\n", __FUNCTION__, module2str(m));
}

int lms_set_precalculated_frequency(struct bladerf *dev, bladerf_module mod,
                                    struct lms_freq *f)
{
    DBG("%s: module=%s, nint=0x%04x, nfrac=0x%08x, freqsel=0x%02x, band=%s\n",
        __FUNCTION__, module2str(mod), f->nint, f->nfrac, f->freqsel,
        f->low_band ? "low" : "high");

    return 0;
}

#endif
